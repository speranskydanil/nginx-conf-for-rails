{"name":"Nginx Configuration For Rails","tagline":"This page describes configuration (example) of the Nginx with Rails (through Unicorn).","body":"# Nginx Configuration For Rails\r\n\r\nThis page describes configuration (example) of the Nginx with Rails (through Unicorn).\r\n\r\n### Nginx\r\n\r\n**/etc/nginx/nginx.conf**\r\n\r\n    worker_processes 8;\r\n\r\n    user nobody nobody;\r\n\r\n    events {\r\n      worker_connections 4096;\r\n      accept_mutex on;\r\n      use epoll;\r\n    }\r\n\r\n    http {\r\n      proxy_buffer_size 128k;\r\n      proxy_buffers 4 256k;\r\n      proxy_busy_buffers_size 256k;\r\n\r\n      client_max_body_size 40M;\r\n\r\n      include mime.types;\r\n      default_type application/octet-stream;\r\n\r\n      sendfile on;\r\n\r\n      gzip on;\r\n      gzip_vary on;\r\n      gzip_proxied any;\r\n      gzip_min_length 500;\r\n      gzip_http_version 1.0;\r\n      gzip_disable \"MSIE [1-6]\\.\";\r\n      gzip_types text/plain text/xml text/css text/javascript application/x-javascript application/xml application/json;\r\n\r\n      server {\r\n        return 404;\r\n      }\r\n\r\n      include /etc/nginx/servers/*;\r\n    }\r\n\r\n**/etc/nginx/servers/example.conf**\r\n\r\n    server {\r\n      listen 80;\r\n      server_name dsperansky.info;\r\n      root /var/www/dsperansky.info/public;\r\n\r\n      location ~* ^/assets/ { expires 1d; }\r\n\r\n      location / {\r\n        try_files $uri @unicorn;\r\n      }\r\n\r\n      location @unicorn {\r\n        proxy_pass http://unix:/var/www/dsperansky.info/tmp/sockets/unicorn.sock;\r\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\r\n        proxy_set_header Host $host;\r\n        proxy_redirect off;\r\n      }\r\n    }\r\n\r\n**reload**\r\n\r\n    /etc/init.d/nginx reload\r\n\r\n### Rails & Unicorn\r\n\r\n**config/unicorn.rb**\r\n\r\n    worker_processes 5\r\n\r\n    dir = '/var/www/dlibrary.org/vsp/'\r\n\r\n    working_directory dir\r\n\r\n    preload_app true\r\n\r\n    listen dir + 'tmp/sockets/unicorn.sock', :backlog => 64\r\n\r\n    timeout 60\r\n\r\n    pid dir + 'tmp/pids/unicorn.pid'\r\n\r\n    stderr_path dir + 'log/unicorn.stderr.log'\r\n    stdout_path dir + 'log/unicorn.stdout.log'\r\n\r\n    before_fork do |server, worker|\r\n      defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!\r\n    end\r\n\r\n    after_fork do |server, worker|\r\n      defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\r\n    end\r\n\r\n**start**\r\n\r\n    test -s \"tmp/pids/unicorn.pid\" && kill -QUIT `cat tmp/pids/unicorn.pid`\r\n\r\n**stop**\r\n\r\n    bundle exec unicorn -c config/unicorn.rb -E production -D'\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}