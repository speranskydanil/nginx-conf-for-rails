<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Nginx Configuration For Rails by speranskydanil</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Nginx Configuration For Rails</h1>
      <h2 class="project-tagline">This page describes configuration (example) of the Nginx with Rails (through Unicorn).</h2>
      <a href="https://github.com/speranskydanil/nginx-conf-for-rails" class="btn">View on GitHub</a>
      <a href="https://github.com/speranskydanil/nginx-conf-for-rails/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/speranskydanil/nginx-conf-for-rails/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="nginx-configuration-for-rails" class="anchor" href="#nginx-configuration-for-rails" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nginx Configuration For Rails</h1>

<p>This page describes configuration (example) of the Nginx with Rails (through Unicorn).</p>

<h3>
<a id="nginx" class="anchor" href="#nginx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nginx</h3>

<p><strong>/etc/nginx/nginx.conf</strong></p>

<pre><code>worker_processes 8;

user nobody nobody;

events {
  worker_connections 4096;
  accept_mutex on;
  use epoll;
}

http {
  proxy_buffer_size 128k;
  proxy_buffers 4 256k;
  proxy_busy_buffers_size 256k;

  client_max_body_size 40M;

  include mime.types;
  default_type application/octet-stream;

  sendfile on;

  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_min_length 500;
  gzip_http_version 1.0;
  gzip_disable "MSIE [1-6]\.";
  gzip_types text/plain text/xml text/css text/javascript application/x-javascript application/xml application/json;

  server {
    return 404;
  }

  include /etc/nginx/servers/*;
}
</code></pre>

<p><strong>/etc/nginx/servers/example.conf</strong></p>

<pre><code>server {
  listen 80;
  server_name dsperansky.info;
  root /var/www/dsperansky.info/public;

  location ~* ^/assets/ { expires 1d; }

  location / {
    try_files $uri @unicorn;
  }

  location @unicorn {
    proxy_pass http://unix:/var/www/dsperansky.info/tmp/sockets/unicorn.sock;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_redirect off;
  }
}
</code></pre>

<p><strong>reload</strong></p>

<pre><code>/etc/init.d/nginx reload
</code></pre>

<h3>
<a id="rails--unicorn" class="anchor" href="#rails--unicorn" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rails &amp; Unicorn</h3>

<p><strong>config/unicorn.rb</strong></p>

<pre><code>worker_processes 5

dir = '/var/www/dlibrary.org/vsp/'

working_directory dir

preload_app true

listen dir + 'tmp/sockets/unicorn.sock', :backlog =&gt; 64

timeout 60

pid dir + 'tmp/pids/unicorn.pid'

stderr_path dir + 'log/unicorn.stderr.log'
stdout_path dir + 'log/unicorn.stdout.log'

before_fork do |server, worker|
  defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!
end

after_fork do |server, worker|
  defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection
end
</code></pre>

<p><strong>start</strong></p>

<pre><code>test -s "tmp/pids/unicorn.pid" &amp;&amp; kill -QUIT `cat tmp/pids/unicorn.pid`
</code></pre>

<p><strong>stop</strong></p>

<pre><code>bundle exec unicorn -c config/unicorn.rb -E production -D'
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/speranskydanil/nginx-conf-for-rails">Nginx Configuration For Rails</a> is maintained by <a href="https://github.com/speranskydanil">speranskydanil</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-48799405-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

